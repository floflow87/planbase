**Contexte**

Construire dans Planbase, depuis le menu Notes, un éditeur de notes **à blocs** avec **commandes `/`**, mise en forme riche et **liens contextuels** ( vers projets, tâches, clients), conforme au modèle de données déjà défini dans Supabase. 

---

## 1) Objectif UX

- Une page “Nouvelle note” où l’utilisateur peut **taper, formater, structurer et relier** son contenu en quelques secondes.
- UX fluide, **slash menu** instantané, **autosave**, et **aperçu propre** côté lecture.
- Compatibilité clavier totale (raccourcis).

---

## 2) Périmètre (MVP+)

### 2.1 Blocs pris en charge

- **Texte/Paragraphe**, **Titres** (H1/H2/H3)
- **Listes** (puces, numérotées), **Checklist**
- **Citation**, **Encadré / Callout** (icône + fond)
- **Séparateur** (divider)
- **Table des matières** (générée à partir des Hx)
- **Image** (upload → Supabase Storage, drag & drop, resize)
- **Lien URL** (auto-détection, carte d’aperçu simple si possible)
- **Table simple** (colonnes/lignes basiques)

### 2.2 Mise en forme inline

- **Gras**, *Italique*, Souligné, ~~Barré~~, `Code`
- Lien inline, couleur de surlignage (palette limitée)
- Commandes contextuelles (mini toolbar flottante)

### 2.3 Commandes `/` (slash menu)

Quand l’utilisateur tape `/`, afficher un **menu de commandes filtrable** avec icônes.

- **Structure** : `/h1`, `/h2`, `/h3`, `/divider`, `/toc` (table des matières)
- **Texte** : `/paragraphe`, `/citation`, `/callout`
- **Listes** : `/liste`, `/liste numérotée`, `/checklist`
- **Média** : `/image`, `/lien`,
- **Liens Planbase** :
    - `/lien projet` → picker “Projets” puis redirige vers la fiche du projet
    - `/lien tâche` → picker “Tâches”
    - `/lien client` → picker “Clients”

### 2.4 Liens contextuels (entités)

- Bloc de **référence** compact (icône + titre + type + lien) pour Projet/Tâche/Client.

### 2.5 Gestion des fichiers

- **Upload** d’images (et fichiers simples) vers **Supabase Storage (prévoir un S3 dans Supabase ?)**.
- Associer les fichiers à la note.
- Bouton “Joindre un fichier” (aperçu vignettes pour images).

### 2.6 Organisation & métadonnées

- Titre de la note (inline), **tags** (multi), **statut** (draft/active/archived).
- Affichage des **liens** (client/projet/tâche) dans la sidebar droite.
- **Versioning** : sauvegarde automatique de versions (manuelle via bouton “Créer version”) →

---

## 3) Comportements essentiels

- **Autosave** (debounce 800–1200 ms) + indicateur “Enregistré”.
- **Undo/Redo** (Ctrl/Cmd+Z / Shift+Cmd+Z).
- **Coller** depuis le presse-papier (texte + basique HTML → blocs).
- **Drag & drop** des blocs (grip visible au hover).
- **Raccourcis** :
    - `#` + espace → H1, `##` H2, `###` H3
    - + espace → liste, `1.` + espace → liste num, `[]` → checklist
    - `>` + espace → citation, ````` + entrée → code block
    - `Ctrl/Cmd+B/I/U` gras/italique/souligné
    - `/` ouvre les commande

---

## 4) Non-fonctionnel / Qualité

- **Performances** : éditeur réactif pour 20–30k caractères (100+ blocs).
- **Logs** : événements “note_saved”, “slash_used”, “block_added”, “link_added”.
- **Sécurité** : nettoyage HTML/links, taille max images (compress côté client).

---

## 5) Critères d’acceptation

- Taper texte + titres + listes + checklist + callout + citation + code + divider + images fonctionne sans bug.
- `/` ouvre le menu, filtrage en temps réel, insertion du bon bloc.
- Picker projet/tâche/client opérationnel, crée et rend un bloc de référence.
- Autosave + version manuelle OK, restauration depuis la table appropriée OK.
- Upload image → Storage Supabase → rendu responsive avec cap de largeur.
- **Partage client RO** : rendu lecture-only sans outils d’édition