Tu travailles dans le repo PlanBase (monorepo Node/Express + React + Strapi).
Objectif : rÃ©organiser la racine du projet SANS RIEN CASSER (aucun import Ã  modifier, aucun build Ã  modifier). Utiliser git mv quand câ€™est possible.

Ã‰tape 0 â€” SÃ©curitÃ©

VÃ©rifie lâ€™Ã©tat Git : git status.

Si des fichiers non committÃ©s existent, ne supprime rien et nâ€™Ã©crase rien.

Ne touche pas Ã  client/, server/, shared/, planbase-admin/, package.json, package-lock.json, dist/, node_modules/.

Ã‰tape 1 â€” CrÃ©er la doc Strapi

CrÃ©er le dossier docs/ sâ€™il nâ€™existe pas, puis crÃ©er le fichier :

docs/strapi.md

Contenu exact Ã  mettre dans docs/strapi.md :
(Important : remplacer uniquement les endpoints /config/all par /api/config/all et /config/feature-flags par /api/config/feature-flags et /config/ping par /api/config/ping si prÃ©sent)

ğŸ“˜ PlanBase â€” Architecture Config & Strapi
ğŸ¯ Objectif

PlanBase utilise Strapi comme back-office dynamique pour :

Feature flags

Enums (valeurs de select)

Templates (CDC, Roadmap, OKRâ€¦)

Registry global (config mÃ©tier)

Plans & pricing

Lâ€™objectif est de ne plus redeployer lâ€™application pour modifier des valeurs de configuration.

ğŸ§  Architecture globale
Strapi (admin.planbase.io)
        â†“ (API token sÃ©curisÃ©)
Express backend (/api/config/*)
        â†“
React frontend (useConfig hook)


Strapi = source de vÃ©ritÃ©
Backend = couche dâ€™agrÃ©gation + fallback
Frontend = consommation via hooks

ğŸ” Variables dâ€™environnement requises (Render)
Backend (planbase)
STRAPI_URL=https://admin.planbase.io
STRAPI_API_TOKEN=xxxxxxxxxxxxxxxx

Strapi (planbase-admin)

Configurer normalement Supabase + DB Postgres.

ğŸŒ Endpoints backend importants
Sanity check
GET /api/config/ping


Doit retourner :

{ "ok": true }

Configuration complÃ¨te
GET /api/config/all


Retourne :

{
  "plans": [],
  "featureFlags": [],
  "featureFlagsMap": {},
  "registry": [],
  "registryMap": {},
  "cdcTemplates": [],
  "roadmapTemplates": [],
  "okrTemplates": [],
  "resourceTemplates": [],
  "faq": [],
  "onboarding": [],
  "accountActions": []
}


âš ï¸ Si 404 :

VÃ©rifier que le backend est bien dÃ©ployÃ©

VÃ©rifier que Render pointe vers le bon repo (planbase)

VÃ©rifier que le build a bien gÃ©nÃ©rÃ© dist/index.js

ğŸ—ï¸ Strapi â€” Structure attendue
1ï¸âƒ£ Feature Flags

Content-type : feature-flags

Champs :

key (string, unique)

enabled (boolean)

description (optional)

Exemple :

key: okr_tree_view
enabled: true

2ï¸âƒ£ Config Registry (Enums dynamiques)

Content-type : configs

Champs :

key (string)

value (JSON)

is_active (boolean)

ğŸ›ï¸ Enums dynamiques supportÃ©s
Key	Description
project.stages	Ã‰tapes projet
task.priorities	PrioritÃ©s tÃ¢che
task.statuses	Statuts tÃ¢che
billing.statuses	Statuts facturation
time.categories	CatÃ©gories temps
thresholds	Seuils mÃ©tier
ğŸ“Œ Exemple JSON â€” project.stages
[
  { "key": "prospection", "label": "Prospection", "order": 10 },
  { "key": "in_progress", "label": "En cours", "order": 20 },
  { "key": "delivered", "label": "LivrÃ©", "order": 30 }
]

âš™ï¸ Frontend â€” Consommation

Hook principal :

useConfig()


Retourne :

{
  projectStages,
  taskPriorities,
  taskStatuses,
  billingStatuses,
  timeCategories,
  thresholds
}


Toujours fallback sur valeurs hardcodÃ©es si Strapi est indisponible.

ğŸ›¡ï¸ SÃ©curitÃ© & Bonnes pratiques

Toujours Save + Publish dans Strapi

Ne pas exposer les endpoints publics inutiles

Utiliser API Token Read Only

Ne jamais supprimer les fallbacks hardcodÃ©s

Toujours valider le type JSON cÃ´tÃ© backend

ğŸ§ª ScÃ©nario de test rapide
1ï¸âƒ£ VÃ©rifier connexion
https://app.planbase.io/api/config/all

2ï¸âƒ£ VÃ©rifier config
https://app.planbase.io/api/config/all

3ï¸âƒ£ Modifier un enum

Strapi â†’ Configs

Modifier project.stages

Publish

Refresh PlanBase

VÃ©rifier changement sans redeploy

ğŸš¨ ProblÃ¨mes connus
âŒ 404 sur /api/config/all

Cause probable :

Mauvais start command Render

dist/index.js non gÃ©nÃ©rÃ©

Mauvais repo branchÃ©

Route dÃ©finie aprÃ¨s serveStatic() (ordre middleware)

âŒ CrÃ©ation projets [Recovered]

Cause :

Script de restauration ou fallback interne
Solution :

Validation en POST/PATCH sur /api/projects

Bloquer noms contenant [Recovered], Projet manquant, etc.

ğŸ§­ Workflow recommandÃ©
Quand tu modifies Strapi :

â†’ Pas besoin de redeployer PlanBase

Quand tu modifies backend Express :

â†’ push sur repo planbase
â†’ Render redeploy

Quand tu modifies Strapi code :

â†’ push sur repo planbase-admin
â†’ Render redeploy

ğŸ Ã‰tat actuel

Si :

/api/config/all fonctionne

Les enums changent dynamiquement

Feature flags remontent

Aucun projet [Recovered] ne se recrÃ©e

ğŸ‘‰ Alors Strapi est correctement intÃ©grÃ©.

ğŸŒŸ Prochaine Ã©tape recommandÃ©e

Ajouter versioning des configs

Ajouter audit log sur changements Strapi

Ajouter environnement staging

Ajouter cache Redis pour config

Ã‰tape 2 â€” RÃ©organisation SAFE de la racine (uniquement rangement)

CrÃ©er ces dossiers sâ€™ils nâ€™existent pas :

docs/

database/migrations/

infra/render/

infra/dns/

infra/storage/

Ensuite dÃ©placer (avec git mv):

Vers docs/

DÃ©placer ces fichiers sâ€™ils existent :

DEPLOYMENT.md

DOCUMENTATION.md

SECURITY_MULTI_TENANT.md

KPIS_BILLING_PAYMENTS.md

TECHNICAL_DEBT.md

CHANGELOG_SESSION.md

PATCH_NOTES.md

design_guidelines.md

CRITICAL_SECURITY_TODO.md

Note : ne pas dÃ©placer README.md.

Vers database/migrations/

DÃ©placer tous les fichiers SQL qui commencent par supabase- et se terminent par .sql
Exemples : supabase-schema.sql, supabase-add-documents.sql, etc.

Vers infra/render/

DÃ©placer :

render-build.sh

render-start.sh

RENDER_DEPLOYMENT.md (si prÃ©sent)

Vers infra/dns/

DÃ©placer :

DNS-CONFIGURATION-OVH.md

Vers infra/storage/

DÃ©placer :

STORAGE_SETUP.md

Ã‰tape 3 â€” Ne pas casser le build

Ne pas dÃ©placer :

vite.config.ts

tsconfig.json

postcss.config.js

tailwind.config.ts

vitest.config.ts

drizzle.config.ts

(les laisser Ã  la racine pour Ã©viter tout risque)

Ã‰tape 4 â€” Mise Ã  jour des liens doc

Si des fichiers doc dÃ©placÃ©s contiennent des liens relatifs, les corriger si nÃ©cessaire (sans toucher au code applicatif).

Ã‰tape 5 â€” VÃ©rification

Lancer npm run build pour sâ€™assurer que tout compile.

Lancer npm run dev pour sâ€™assurer que lâ€™app dÃ©marre.

VÃ©rifier que client/, server/, planbase-admin/, shared/ nâ€™ont pas Ã©tÃ© modifiÃ©s.

Ã‰tape 6 â€” RÃ©sultat

Ã€ la fin :

me donner la liste des fichiers dÃ©placÃ©s

me donner git status

ne pas committer automatiquement (je dÃ©ciderai)